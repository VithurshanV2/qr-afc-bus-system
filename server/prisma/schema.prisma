// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  // directUrl = env("DIRECT_URL")
}

model User {
  id       Int     @id @default(autoincrement())
  name     String
  email    String  @unique
  number   String?
  password String?
  googleId String? @unique
  provider String?

  role Role @default(COMMUTER)

  verifyOtp         String?
  verifyOtpExpireAt DateTime?
  isAccountVerified Boolean   @default(false)
  resetOtp          String?
  resetOtpExpireAt  DateTime?

  isFirstLogin Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  wallet      Wallet?
  BusOperator BusOperator?
  Ticket      Ticket[]

  createdRoutes           Route[]                  @relation("RouteCreatedBy")
  updatedRoutes           Route[]                  @relation("RouteUpdatedBy")
  busOperatorRequests     BusOperatorRequest[]
  accountActivationTokens AccountActivationToken[]
}

enum Role {
  COMMUTER
  BUSOPERATOR
  TRANSPORTAUTHORITY
}

model Wallet {
  id        Int      @id @default(autoincrement())
  user      User     @relation(fields: [userId], references: [id])
  userId    Int      @unique
  balance   Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  transactions WalletTransaction[]
}

model WalletTransaction {
  id          Int             @id @default(autoincrement())
  wallet      Wallet          @relation(fields: [walletId], references: [id])
  walletId    Int
  amount      Int
  type        TransactionType
  description String?
  sessionId   String?         @unique
  createdAt   DateTime        @default(now())

  @@index([walletId])
}

enum TransactionType {
  CREDIT
  DEBIT
}

model BusOperator {
  id        Int      @id @default(autoincrement())
  user      User     @relation(fields: [userId], references: [id])
  userId    Int      @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  Bus       Bus[]
}

model Bus {
  id                 Int         @id @default(autoincrement())
  registrationNumber String      @unique
  operator           BusOperator @relation(fields: [operatorId], references: [id])
  operatorId         Int
  route              Route?      @relation(fields: [routeId], references: [id])
  routeId            Int?
  qrCode             String      @unique
  createdAt          DateTime    @default(now())
  updatedAt          DateTime    @updatedAt
  Trip               Trip[]
}

model Trip {
  id        Int           @id @default(autoincrement())
  bus       Bus           @relation(fields: [busId], references: [id])
  busId     Int
  route     Route         @relation(fields: [routeId], references: [id])
  routeId   Int
  startTime DateTime      @default(now())
  endTime   DateTime?
  isActive  Boolean       @default(true)
  direction TripDirection
  createdAt DateTime      @default(now())
  Ticket    Ticket[]
}

enum TripDirection {
  DIRECTIONA
  DIRECTIONB
}

model Route {
  id          Int         @id @default(autoincrement())
  number      String
  name        String
  busType     BusType
  status      RouteStatus @default(DRAFT)
  haltsA      Json?
  haltsB      Json?
  createdBy   User        @relation("RouteCreatedBy", fields: [createdById], references: [id])
  createdById Int
  updatedBy   User?       @relation("RouteUpdatedBy", fields: [updatedById], references: [id])
  updatedById Int?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  Bus         Bus[]
  Trip        Trip[]

  @@unique([number, busType])
}

enum RouteStatus {
  DRAFT
  ACTIVE
  INACTIVE
  DELETED
}

enum BusType {
  NORMAL
  SEMILUXURY
  LUXURY
  SUPERLUXURY
}

model Ticket {
  id              Int          @id @default(autoincrement())
  commuter        User         @relation(fields: [commuterId], references: [id])
  commuterId      Int
  trip            Trip         @relation(fields: [tripId], references: [id])
  tripId          Int
  boardingHalt    Json
  destinationHalt Json?
  adultCount      Int          @default(1)
  childCount      Int          @default(0)
  baseFare        Int?
  totalFare       Int?
  status          TicketStatus @default(PENDING)
  issuedAt        DateTime     @default(now())
  expiresAt       DateTime?
  cancelledAt     DateTime?
  qrCode          String       @unique

  @@index([commuterId, status])
}

enum TicketStatus {
  PENDING
  EXPIRED
  CONFIRMED
  CANCELLED
}

model BusOperatorRequest {
  id           Int           @id @default(autoincrement())
  name         String
  nic          String
  email        String
  number       String
  address      String
  buses        Json
  uploadedDocs Json
  status       RequestStatus @default(PENDING)
  remarks      String?
  reviewedBy   User?         @relation(fields: [reviewedById], references: [id])
  reviewedById Int?
  reviewedAt   DateTime?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
}

enum RequestStatus {
  PENDING
  APPROVED
  REJECTED
}

model AccountActivationToken {
  id        Int      @id @default(autoincrement())
  user      User     @relation(fields: [userId], references: [id])
  userId    Int      @unique
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
}
